name: "Publish Client Dev Preview on PR Merge"

on:
  pull_request_target:
    types: [closed]
    paths:
      - "packages/client/**"
      - "packages/cherry-markdown/**"
      - "!packages/cherry-markdown/test/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read
  issues: write

jobs:
  client-preview:
    # ä¸éœ€è¦åœ¨forkä»“åº“çš„prä¸­è¿è¡Œ, ä»…å½“pråˆå¹¶æ—¶è¿è¡Œ
    if: github.repository == 'Tencent/cherry-markdown' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'dev'
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 4  # æ˜¾å¼è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            platform_name: macos
            arch: arm64
            args: "--target aarch64-apple-darwin"
            # ç²¾ç¡®åŒ¹é… target ç›®å½•ä¸‹çš„äº§ç‰©
            path_patterns: |
              ./packages/client/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
              ./packages/client/src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
          - platform: macos-latest
            target: x86_64-apple-darwin
            platform_name: macos
            arch: x64
            args: "--target x86_64-apple-darwin"
            path_patterns: |
              ./packages/client/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
              ./packages/client/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            platform_name: windows
            arch: x64
            path_patterns: |
              ./packages/client/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
              ./packages/client/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          - platform: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform_name: linux
            arch: x64
            path_patterns: |
              ./packages/client/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
              ./packages/client/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb/*.deb

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "yarn"

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}
          toolchain: stable

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/client/src-tauri -> target

      - name: Install Linux Dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Get Version
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./packages/client/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build Tauri
        run: |
          yarn --network-timeout 100000
          yarn build
          yarn build:client ${{ matrix.args || '' }}

      - name: Create Artifact Info
        shell: bash
        run: |
          mkdir -p ./artifact-info
          
          # èŽ·å–ç‰ˆæœ¬å·å’Œæž„å»ºä¿¡æ¯
          VERSION="${{ steps.version.outputs.version }}"
          PLATFORM="${{ matrix.platform_name }}"
          ARCH="${{ matrix.arch }}"
          TARGET="${{ matrix.target }}"
          ARTIFACT_NAME="cherry-markdown-client-$VERSION-$PLATFORM-$ARCH"
          
          # åˆ›å»ºäº§ç‰©ä¿¡æ¯æ–‡ä»¶
          echo "version=$VERSION" > ./artifact-info/build-info.txt
          echo "platform=$PLATFORM" >> ./artifact-info/build-info.txt
          echo "arch=$ARCH" >> ./artifact-info/build-info.txt
          echo "target=$TARGET" >> ./artifact-info/build-info.txt
          echo "artifact_name=$ARTIFACT_NAME" >> ./artifact-info/build-info.txt
          
          # ç²¾ç¡®æŸ¥æ‰¾å¯¹åº” target ç›®å½•ä¸‹çš„æž„å»ºäº§ç‰©
          TARGET_DIR="./packages/client/src-tauri/target/$TARGET/release/bundle"
          
          if [ -d "$TARGET_DIR" ]; then
            find "$TARGET_DIR" -type f \( -name "*.dmg" -o -name "*.msi" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" \) -exec basename {} \; > ./artifact-info/files.txt
            find "$TARGET_DIR" -type d -name "*.app" -exec basename {} \; >> ./artifact-info/files.txt
          fi
          
          if [ ! -s ./artifact-info/files.txt ]; then
            echo "No cherry-markdown build artifacts found!" > ./artifact-info/files.txt
          fi
          
          # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
          echo "Build Info:"
          cat ./artifact-info/build-info.txt
          echo "Cherry-Markdown Artifacts:"
          cat ./artifact-info/files.txt

      - name: Upload Cherry-Markdown Client Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cherry-markdown-client-${{ steps.version.outputs.version }}-${{ matrix.platform_name }}-${{ matrix.arch }}
          path: ${{ matrix.path_patterns }}
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Artifact Info
        uses: actions/upload-artifact@v4
        with:
          name: artifact-info-${{ matrix.platform_name }}-${{ matrix.arch }}
          path: ./artifact-info/
          retention-days: 30

  post-preview-comment:
    needs: client-preview
    runs-on: ubuntu-latest
    if: github.repository == 'Tencent/cherry-markdown' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'dev'
    steps:
      - name: Download All Artifact Info
        uses: actions/download-artifact@v4
        with:
          pattern: artifact-info-*
          path: ./artifact-info

      - name: Generate PR Comment with Cherry-Markdown Artifacts
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            // èŽ·å–æœ¬æ¬¡ workflow run çš„æ‰€æœ‰ artifacts
            const { data: artifactList } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId
            });

            // æž„å»º artifact åç§°åˆ°ä¸‹è½½é“¾æŽ¥çš„æ˜ å°„
            const artifactDownloadUrls = {};
            for (const artifact of artifactList.artifacts) {
              // GitHub artifact ä¸‹è½½é“¾æŽ¥æ ¼å¼
              artifactDownloadUrls[artifact.name] = `https://github.com/${owner}/${repo}/actions/runs/${runId}/artifacts/${artifact.id}`;
            }

            // è¯»å–æž„å»ºä¿¡æ¯
            const artifactInfoDir = './artifact-info';
            const artifacts = [];

            if (fs.existsSync(artifactInfoDir)) {
              const dirs = fs.readdirSync(artifactInfoDir);
              
              for (const dir of dirs) {
                const buildInfoPath = path.join(artifactInfoDir, dir, 'build-info.txt');
                const filesPath = path.join(artifactInfoDir, dir, 'files.txt');
                
                if (fs.existsSync(buildInfoPath) && fs.existsSync(filesPath)) {
                  // è§£æžæž„å»ºä¿¡æ¯
                  const buildInfo = {};
                  const buildInfoContent = fs.readFileSync(buildInfoPath, 'utf8');
                  buildInfoContent.split('\n').forEach(line => {
                    const [key, value] = line.split('=');
                    if (key && value) {
                      buildInfo[key.trim()] = value.trim();
                    }
                  });
                  
                  // è¯»å–æ–‡ä»¶åˆ—è¡¨
                  const files = fs.readFileSync(filesPath, 'utf8')
                    .trim()
                    .split('\n')
                    .filter(f => f && f !== 'No cherry-markdown build artifacts found!');
                  
                  if (files.length > 0) {
                    // èŽ·å–å¯¹åº”çš„ä¸‹è½½é“¾æŽ¥
                    const artifactName = buildInfo.artifact_name;
                    const downloadUrl = artifactDownloadUrls[artifactName] || `${runUrl}/artifacts`;
                    
                    artifacts.push({
                      ...buildInfo,
                      files: files,
                      downloadUrl: downloadUrl
                    });
                  }
                }
              }
            }

            // ç”Ÿæˆè¯„è®ºå†…å®¹
            let body = '## ðŸš€ Cherry-Markdown å®¢æˆ·ç«¯é¢„è§ˆæž„å»ºå·²å®Œæˆ\n\n';
            
            if (artifacts.length === 0) {
              body += '> âš ï¸ æœªæ‰¾åˆ°æž„å»ºäº§ç‰©ï¼Œè¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ã€‚\n\n';
              body += `[æŸ¥çœ‹æž„å»ºè¯¦æƒ…](${runUrl})\n`;
            } else {
              // æŒ‰å¹³å°åˆ†ç»„
              const platformOrder = ['macOS', 'Windows', 'Linux'];
              const platformGroups = {
                'macOS': [],
                'Windows': [],
                'Linux': []
              };
              
              artifacts.forEach(artifact => {
                const platform = artifact.platform;
                let platformKey = 'Linux';
                if (platform === 'macos') platformKey = 'macOS';
                else if (platform === 'windows') platformKey = 'Windows';
                
                platformGroups[platformKey].push({
                  artifactName: artifact.artifact_name,
                  arch: artifact.arch,
                  downloadUrl: artifact.downloadUrl,
                  version: artifact.version,
                  files: artifact.files
                });
              });
              
              // ç”Ÿæˆè¡¨æ ¼
              body += '| å¹³å° | æž¶æž„ | äº§ç‰© | ä¸‹è½½ |\n';
              body += '|------|------|------|------|\n';
              
              for (const platform of platformOrder) {
                const items = platformGroups[platform];
                if (items.length > 0) {
                  items.sort((a, b) => a.arch.localeCompare(b.arch));
                  
                  for (const item of items) {
                    const archLabel = item.arch === 'arm64' ? 'Apple Silicon' : 
                                     item.arch === 'x64' ? 'x64' : item.arch;
                    const filesStr = item.files.map(f => `\`${f}\``).join(', ');
                    body += `| ${platform} | ${archLabel} | ${filesStr} | [ä¸‹è½½](${item.downloadUrl}) |\n`;
                  }
                }
              }
              
              body += `\n> ðŸ“‹ ç‰ˆæœ¬: \`${artifacts[0]?.version || 'unknown'}\` | [æŸ¥çœ‹æ‰€æœ‰æž„å»ºäº§ç‰©](${runUrl})\n`;
            }

            // åˆ›å»ºè¯„è®º
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: owner,
              repo: repo,
              body: body
            });
